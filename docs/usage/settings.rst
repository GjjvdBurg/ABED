======================
The Abed Settings file
======================

As a user, the settings file is the place where you'll define your experiment 
for Abed. Since there are quite some settings that can be influenced, the 
settings file contains different sections with related settings. These 
sections are reflected in the documentation below.

.. contents::
    :local:
    :depth: 1


General settings
================

.. setting:: PROJECT_NAME

``PROJECT_NAME``
----------------

Default: ``''``

The name of the project to use. This setting is used in the default of the 
setting :setting:`REMOTE_DIR`, and can therefore not be empty when accepting 
the default for that setting. It can contain a forward slash (``/``), when 
necessary. The project name further only occurs in the HTML output generated 
by Abed.

.. setting:: TASK_FILE

``TASK_FILE``
-------------

Default: :py:const:`abed.constants.TASKS_FILENAME`

This is the filename of the task file. It shouldn't generally need to be 
changed from the default value.


.. setting:: AUTO_FILE

``AUTO_FILE``
-------------

Default: :py:const:`abed.constants.AUTO_FILENAME`

This is the filename of the auto file. It shouldn't generally need to be 
changed from the default value.

.. setting:: RESULT_DIR

``RESULT_DIR``
--------------

Default: ``'/path/to/local/results'``

Path to the local results directory. This is where the results of all 
computations will end up in the end. Because this can be potentially large, it 
is wise to consider the location of this path carefully. For instance, when 
working in a Dropbox folder, it may not be feasible to store all results in 
Dropbox. To ensure this is considered, the default path is not directly 
useable and should be changed by the user.

.. setting:: STAGE_DIR

``STAGE_DIR``
-------------

Default: ``'/path/to/local/stagedir'``

Path to local stage directory. This is the directory where the results are 
temporarily stored before being moved to the result directory. The same 
considerations apply as are specified in the setting :setting:`RESULT_DIR`.  
The default should be adjusted by the user.

.. setting:: MAX_FILES

``MAX_FILES``
-------------

Default: ``1000``

The maximum number of files stored in a result directory on the remote. When 
results are generated on the remote, they are placed in subdirectories of at 
most this many files. Each subdirectory will later be zipped before it can be 
downloaded from the remote, so it can be useful to not make the zip files too 
large. With this setting a limit can be placed on the number of files per 
subdirectory of the remote result directory, and therefore on the size of the 
zip files that need to be downloaded. The default should be fine for most 
users.

.. setting:: ZIP_DIR

``ZIP_DIR``
-----------

Default: ``'./zips'``

Path to the local zip directory. This is where the compressed zip files with 
results are stored. These files will be unpacked into the stage dir and moved 
to the result directory (see :setting:`RESULT_DIR`). The zip files are kept by 
Abed for posterity, but can be removed when the user sees no need for them 
anymore (the raw results will be kept in the result directory).

.. setting:: LOG_DIR

``LOG_DIR``
-----------

Default: ``'./logs'``

Local path where the PBS logs will be kept.

.. setting:: OUTPUT_DIR

``OUTPUT_DIR``
--------------

Default: ``'./output'``

Local path where the output files are placed that are generated by Abed.

.. setting:: AUTO_SLEEP

``AUTO_SLEEP``
--------------

Default: ``120``

Sleep time in seconds between consecutive checks on the remote when running in 
auto mode. In auto mode Abed checks the remote repeatedly to see if a 
submitted task is finished, so it can pull the results and submit a new task.  
The time between checks is defined here. See also 
:doc:`../api/core/abed.auto`.

.. setting:: HTML_PORT

``HTML_PORT``
--------------

Default: ``8000``

Port on the localhost where the HTML pages will be served on. This is used by 
the function :py:func:`abed.html.view.view_html`. It will be automatically 
incremented when the port is in use. It should not generally have to be 
changed by the user.

.. setting:: COMPRESSION

``COMPRESSION``
---------------

Default: ``'bzip2'``

Compression algorithm to use when compressing finished result directories.  
Abed can compress result files automatically when all computations for a 
dataset are finished. This is the algorithm that is used by Abed to compress 
the tar file that results. Allowed choices are: ``bzip2``, ``gzip``, and 
``lzma``. See also the documentation in :doc:`../api/core/abed.compress`.

Server parameters and settings
==============================

.. setting:: REMOTE_USER

``REMOTE_USER``
---------------

Default: ``'username'``

Username on the remote server. This is assumed to be the username to use when 
logging in on the remote server, and under which the jobs will be submitted.  
It should be changed by the user.

.. setting:: REMOTE_HOST

``REMOTE_HOST``
---------------

Default: ``'address.of.host'``

The address of the remote server. For instance, for the Dutch LISA compute 
cluster, it is ``lisa.surfsara.nl``. It should be changed by the user.

.. setting:: REMOTE_DIR

``REMOTE_DIR``
--------------

Default: ``'/home/%s/projects/%s' % (REMOTE_USER, PROJECT_NAME)``

Path on the remote server to place all project files in. The default assumes 
that the remote server is a Unix server with the standard directory layout. It 
uses the :setting:`REMOTE_USER` setting and the :setting:`PROJECT_NAME` 
setting to construct the remote path. Therefore, it shouldn't necessarily have 
to be changed by the user.

.. setting:: REMOTE_PORT

``REMOTE_PORT``
---------------

Default: ``22``

Remote communication port to use. Usually communication is done over the SSH 
port, so that is the default. To learn more about how communication is done 
with the remote server, see :doc:`../api/core/abed.fab` and 
:doc:`../api/core/abed.fab_util`.

.. setting:: REMOTE_SCRATCH

``REMOTE_SCRATCH``
------------------

Default: ``None``

Typically, it is more efficient to place results generated by a job on the 
compute cluster on a disk which is close to the node which executes the job, 
as opposed to in the user's home directory. Such a directory is called the 
*scratch* directory, and it is typically erased after a job is finished. Abed 
places the results it generates on this scratch directory, and periodically 
copies them to the home directory of the user, to lower the burden on the 
network of the cluster. On the Dutch LISA cluster, the path to the scratch 
directory is given by an environment variable, but on other systems it may be 
a fixed location.  This setting exists for the latter case. For the former 
case, see :setting:`REMOTE_SCRATCH_ENV`.  This setting is used by 
:py:func:`abed.run_utils.get_scratchdir`.

.. setting:: REMOTE_SCRATCH_ENV

``REMOTE_SCRATCH_ENV``
----------------------

Default: ``'TMPDIR'``

See also the description under the setting :setting:`REMOTE_SCRATCH`. This 
setting exists in case the location of the *scratch* directory is given by an 
environment variable. The name of the environment variable can be set here.  
The default corresponds to the name used on the Dutch LISA compute cluster.  
This setting is used by :py:func:`abed.run_utils.get_scratchdir`.

Settings for Master/Worker program
==================================

.. setting:: MW_SENDATONCE

``MW_SENDATONCE``
-----------------

Default: ``100``

When running tasks on the compute node, Abed works through a Master/Worker 
system, where the master thread continually sends out work to the worker 
threads. To reduce communication load, it sends out a number of tasks at once.  
This setting defines how many tasks are sent. Note that as soon as there are 
fewer tasks left than ``n_workers * MW_SENDATONCE``, Abed reduces the number 
of tasks to send to 1.  This ensures that the situation can't occur where one 
worker gets all the remaining tasks whereas other workers get none.

.. setting:: MW_COPY_SLEEP

``MW_COPY_SLEEP``
-----------------

Default: ``120``

Abed reserves one thread on the compute node for copying every once in a while 
the result files from the scratch directory to the home directory (see also 
:setting:`REMOTE_SCRATCH`). This setting defines the time in seconds between 
consecutive copying of the results.

Experiment type
===============

These settings define the type of experiment that Abed will run. For a more 
in-depth overview, see :doc:`experiments`. Note that not all settings apply to 
all types of experiments. Therefore, the initial settings file generated by 
Abed requires the user to uncomment the block of settings relating to the 
specific type of experiment they want to use.

.. setting:: TYPE

``TYPE``
--------

Default: Undefined.

This setting defines the type of experiment that will be run. Valid options 
are ``'ASSESS'``, ``'CV_TT'``, and ``'RAW'``. See :doc:`experiments` for a 
more in-depth discussion of the different types.


.. setting:: CV_BASESEED

``CV_BASESEED``
---------------

Default: ``123456``

Only used when the experiment type is ``'CV_TT'``. This defines the base seed 
to use for the generation of the cross-validation seeds. This setting is used 
by the function :py:func:`abed.tasks.init_tasks_cv_tt`.

.. setting:: YTRAIN_LABEL

``YTRAIN_LABEL``
----------------

Default: ``'y_train'``

Only used when the experiment type is ``'CV_TT'``. This defines the label for 
the part in the result file which corresponds to the training set.

.. setting:: RAW_CMD_FILE

``RAW_CMD_FILE``
----------------

Default: ``'/path/to/file.txt'``

Only used when the experiment type is ``'RAW'``. This is the path to the file 
with raw tasks.

Build settings
==============

.. setting:: NEEDS_BUILD

``NEEDS_BUILD``
---------------

Default: ``False``

Whether or not compilation is necessary on the remote.

.. setting:: BUILD_DIR

``BUILD_DIR``
-------------

Default: ``'build'``

Directory where the build command needs to be executed. It is assumed that 
this is a subdirectory of the *current* directory on the remote. The path 
defined here should therefore be the path in the git archive. With the default 
setting, the local Abed directory would look like::

    |--- abed_conf.py
    |--- abed_tasks.txt
    |--- abed_auto.txt
    |--- build
    |--- datasets
    |--- execs


.. setting:: BUILD_CMD

``BUILD_CMD``
-------------

Default: ``'make all'``

The command to run on the remote. This is run in the directory given by the
:setting:`BUILD_DIR` setting.

Experiment parameters and settings
==================================

.. setting:: DATADIR

``DATADIR``
-----------

Default: :py:const:`abed.constants.DATASET_DIRNAME`

The path where the datasets are stored. Note that this does not necessarily 
have to be in the Abed working directory (where you typed ``abed init``).  
However, on the remote the datasets will be placed in a directory called 
``datasets`` in the remote working directory. By using this setting it is 
possible to place your datasets in a directory outside of the Abed working 
directory. This can be very useful when you're running multiple experiments 
that use the same datasets.

.. setting:: EXECDIR

``EXECDIR``
-----------

Default: :py:const:`abed.constants.EXECS_DIRNAME`

The path where the executables are stored. These executables are used in the 
commands that Abed runs (see the setting :setting:`COMMANDS`). It is advisable 
to keep the default setting as this makes it easier to place executables under 
version control.

.. setting:: DATASETS

``DATASETS``
------------

Default: ``['dataset_1', 'dataset_2']``

This setting defines the names of the datasets that will be used in the 
experiments. Abed expects a different type in the list depending on the 
:setting:`TYPE` that is used:

* When TYPE is ``'ASSESS'``, the expected format is the same as the default, 
  simply a list of names of the datasets, as strings.

* When TYPE is ``'CV_TT'``, the expected format is a list of tuples, where 
  each tuple is a pair of strings. The first string gives the name of the 
  training dataset, and the second string the name of the test dataset. For 
  instance::

    DATASETS = [('dataset_1_train', 'dataset_1_test'), ('dataset_2_train', 
    'dataset_2_test')]

* When TYPE is ``'RAW'``, this setting is not used.

See for more info on the different experiment types and their requirements 
:doc:`experiments`.

.. setting:: METHODS

``METHODS``
-----------

Default: ``['method_1', 'method_2']``

.. setting:: PARAMS

``PARAMS``
----------

Default::

    {{
        'method_1': {{
            'param_1': [val_1, val_2],
            'param_2': [val_3, val_4],
            'param_3': [val_5, val_6]
            }},
        'method_2': {{
            'param_1': [val_1, val_2, val_3],
            }},
     }}

.. setting:: COMMANDS

``COMMANDS``
------------

Default::

    {{
        'method_1': ("{{execdir}}/method_1 {{datadir}}/{{dataset}} {{param_1}} "
            "{{param_2}} {{param_3}}"),
        'method_2': "{{execdir}}/method_2 {{datadir}}/{{dataset}} {{param_1}}"
    }}

TODO Abed currently allows two modes of operation: 'ASSESS' for model 
assessment, and 'CV_TT' for cross validation with a test dataset. In the 
latter case the datasets need to be specified with '{train_dataset}' and 
'{test_dataset}' in the Abed configuration file.

.. setting:: METRICS

``METRICS``
-----------

Default::

    {{
        'NAME_1': {{
            'metric': metric_function_1,
            'best': max
            }},
        'NAME_2': {{
            'metric': metric_function_2,
            'best': min
            }}
    }}

.. setting:: SCALARS

``SCALARS``
-----------

Default::

    {{
        'time': {{
            'best': min
            }},
    }}

.. setting:: RESULT_PRECISION

``RESULT_PRECISION``
--------------------

Default: ``4``

.. setting:: DATA_DESCRIPTION_CSV

``DATA_DESCRIPTION_CSV``
------------------------

Default: ``None``

.. setting:: REFERENCE_METHOD

``REFERENCE_METHOD``
--------------------

Default: ``None``

.. setting:: SIGNIFICANCE_LEVEL

``SIGNIFICANCE_LEVEL``
----------------------

Default: ``0.05``

PBS settings
============

.. setting:: PBS_NODES

``PBS_NODES``
-------------

Default: ``1``

.. setting:: PBS_WALLTIME

``PBS_WALLTIME``
----------------

Default: ``360``

.. setting:: PBS_CPUTYPE

``PBS_CPUTYPE``
---------------

Default: ``None``

.. setting:: PBS_CORETYPE

``PBS_CORETYPE``
----------------

Default: ``None``

.. setting:: PBS_PPN

``PBS_PPN``
-----------

Default: ``None``

.. setting:: PBS_MODULES

``PBS_MODULES``
---------------

Default: ``['mpicopy', 'python/2.7.9']``

.. setting:: PBS_EXPORTS

``PBS_EXPORTS``
---------------

Default: ``['PATH=$PATH:/home/%s/.local/bin/abed' % REMOTE_USER]``

.. setting:: PBS_MPICOPY

``PBS_MPICOPY``
---------------

Default: ``['{data_dir}', EXECDIR, TASK_FILE]``

.. setting:: PBS_TIME_REDUCE

``PBS_TIME_REDUCE``
-------------------

Default: ``600``
